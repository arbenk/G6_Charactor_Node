<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å›¾åº“</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        /* ç¼©ç•¥å›¾æ ·å¼ */
        .card-thumb {
            width: 100%; height: 120px; background: #e8e8e8; margin-bottom: 10px; border-radius: 4px;
            overflow: hidden; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;
        }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }

        .card h3 { margin: 0 0 5px 0; font-size: 16px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card p { font-size: 12px; color: #999; margin: 0 0 15px 0; }
        
        .actions { display: flex; gap: 8px; margin-top: auto; }
        .btn { border: none; padding: 6px 0; border-radius: 4px; cursor: pointer; font-size: 12px; color: #fff; flex: 1; text-align: center;}
        
        .btn-view { background: #1890ff; }
        .btn-edit { background: #faad14; } /* æ©™è‰²é‡å‘½åæŒ‰é’® */
        .btn-del { background: #ff4d4f; }
        .btn-copy { background: #13c2c2; } /* é’è‰²å¤åˆ¶æŒ‰é’® */
        .btn-create { background: #52c41a; padding: 10px 20px; font-size: 14px; flex: none; }
        
/* ... ä¹‹å‰çš„æ ·å¼ ... */

        /* ============ æ‹–æ‹½è§†è§‰ä¼˜åŒ– ============ */
        .card {
            cursor: grab;
            position: relative;
            transition: transform 0.1s, border-color 0.1s; /* å¢åŠ ä¸€ç‚¹è¿‡æ¸¡åŠ¨ç”» */
        }
        .card:active {
            cursor: grabbing;
        }
        
        /* æ­£åœ¨è¢«æ‹–èµ°çš„å¡ç‰‡ï¼šå˜åŠé€æ˜ï¼ŒåŠ è™šçº¿æ¡† */
        .card.dragging {
            opacity: 0.4;
            border: 2px dashed #bbb;
            background: #f9f9f9;
            pointer-events: none; /* å…³é”®ï¼šé˜²æ­¢é®æŒ¡ä¸‹æ–¹çš„ç›®æ ‡åˆ¤æ–­ */
        }

        /* ç›®æ ‡å¡ç‰‡ï¼šæç¤ºæ’å…¥åˆ°å‰é¢ (å·¦ä¾§è“çº¿) */
        .card.drop-hint-before {
            border-left: 4px solid #1890ff !important;
            padding-left: 12px; /* è°ƒæ•´å†…è¾¹è·é˜²æ­¢å†…å®¹è·³åŠ¨ */
            background: #e6f7ff;
        }

        /* ç›®æ ‡å¡ç‰‡ï¼šæç¤ºæ’å…¥åˆ°åé¢ (å³ä¾§è“çº¿) */
        .card.drop-hint-after {
            border-right: 4px solid #1890ff !important;
            padding-right: 12px;
            background: #e6f7ff;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2>ğŸ“‚ æˆ‘çš„å…³ç³»å›¾åº“</h2>
        <button class="btn btn-create" onclick="createNew()">+ æ–°å»ºå…³ç³»å›¾</button>
    </div>

    <div id="gallery" class="grid">
        <p>æ­£åœ¨åŠ è½½...</p>
    </div>

<script>
        let dragSrcEl = null;

        // åŠ è½½åˆ—è¡¨
        async function loadList() {
            try {
                const res = await fetch('api/api.php?action=get_list');
                const json = await res.json();
                if(json.status === 'success') {
                    renderGrid(json.list);
                }
            } catch(e) { 
                console.error(e);
                // alert('åŠ è½½åˆ—è¡¨å¤±è´¥'); // é¦–æ¬¡åŠ è½½å¤±è´¥å¯ä»¥ä¸å¼¹çª—
            }
        }

        // æ¸²æŸ“ç½‘æ ¼
        function renderGrid(list) {
            const container = document.getElementById('gallery');
            
            if(list.length === 0) {
                container.innerHTML = '<p class="empty-tip">æš‚æ— é¡¹ç›®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å»ºã€‚</p>';
                return;
            }

            container.innerHTML = list.map(item => {
                const safeName = item.project_name.replace(/'/g, "\\'");
                
                let thumbHtml = '<div class="card-thumb">æš‚æ— é¢„è§ˆ</div>';
                if (item.thumbnail) {
                    thumbHtml = `<div class="card-thumb"><img src="${item.thumbnail}"></div>`;
                }
                
                return `
                <div class="card" draggable="true" data-id="${item.id}">
                    ${thumbHtml}
                    <h3 title="${item.project_name}">${item.project_name}</h3>
                    <p>æ›´æ–°äº: ${item.updated_at || 'åˆšåˆš'}</p>
                    <div class="actions">
                        <button class="btn btn-view" onclick="location.href='editor.html?id=${item.id}'">è¿›å…¥</button>
                        <button class="btn btn-copy" onclick="duplicateGraph(${item.id})">å¤åˆ¶</button>
                        <button class="btn btn-edit" onclick="renameGraph(${item.id}, '${safeName}')">æ”¹å</button>
                        <button class="btn btn-del" onclick="deleteGraph(${item.id})">åˆ é™¤</button>
                    </div>
                </div>
            `}).join('');

            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            addDragEvents();
        }

        // === å¤åˆ¶åŠŸèƒ½ ===
        async function duplicateGraph(id) {
            if(!confirm("ç¡®å®šè¦å¤åˆ¶è¿™ä»½å›¾è¡¨å—ï¼Ÿ")) return;
            try {
                const res = await fetch('api/api.php?action=duplicate_graph', { method: 'POST', body: JSON.stringify({ id: id }) });
                const json = await res.json();
                if(json.status === 'success') loadList(); else alert('å¤åˆ¶å¤±è´¥: ' + json.message);
            } catch(e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        // ============ æ‹–æ‹½æ’åºæ ¸å¿ƒé€»è¾‘ (ä¼˜åŒ–ç‰ˆ) ============
        function addDragEvents() {
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave); // [æ–°å¢] ç¦»å¼€å¤„ç†
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            // é˜²æ­¢æ‹–åŠ¨æŒ‰é’®
            if(e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                e.preventDefault();
                return;
            }
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            // å»¶æ—¶æ·»åŠ æ ·å¼ï¼Œè§†è§‰æ›´ä½³
            setTimeout(() => this.classList.add('dragging'), 0);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault(); // å…è®¸æ”¾ç½®
            e.dataTransfer.dropEffect = 'move';

            // å¦‚æœæ˜¯è‡ªå·±ï¼Œæˆ–è€…ä¸æ˜¯å¡ç‰‡å…ƒç´ ï¼Œä¸å¤„ç†
            if (this === dragSrcEl || !this.classList.contains('card')) return;

            // === æ ¸å¿ƒï¼šè®¡ç®—é¼ æ ‡åœ¨ç›®æ ‡å¡ç‰‡çš„å·¦åŠè¾¹è¿˜æ˜¯å³åŠè¾¹ ===
            const rect = this.getBoundingClientRect();
            const horizontalCenter = rect.left + rect.width / 2;

            // å…ˆç§»é™¤æ‰€æœ‰å¯èƒ½çš„æç¤º
            this.classList.remove('drop-hint-before', 'drop-hint-after');

            if (e.clientX < horizontalCenter) {
                // é¼ æ ‡åœ¨ä¸­å¿ƒç‚¹å·¦ä¾§ -> æç¤ºæ’åˆ°å‰é¢
                this.classList.add('drop-hint-before');
            } else {
                // é¼ æ ‡åœ¨ä¸­å¿ƒç‚¹å³ä¾§ -> æç¤ºæ’åˆ°åé¢
                this.classList.add('drop-hint-after');
            }
            return false;
        }

        // [æ–°å¢] é¼ æ ‡ç¦»å¼€å¡ç‰‡æ—¶æ¸…é™¤æç¤º
        function handleDragLeave(e) {
            this.classList.remove('drop-hint-before', 'drop-hint-after');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();

            // æ¸…é™¤ç›®æ ‡å¡ç‰‡çš„æç¤ºæ ·å¼
            this.classList.remove('drop-hint-before', 'drop-hint-after');

            if (dragSrcEl !== this && this.classList.contains('card')) {
                // æ ¹æ®åˆšæ‰ DragOverç•™ä¸‹çš„æ ‡è®°å†³å®šä½ç½®
                const rect = this.getBoundingClientRect();
                const horizontalCenter = rect.left + rect.width / 2;

                // å†æ¬¡åˆ¤æ–­ï¼ˆæ¯”ä¾èµ– class æ›´ç¨³å®šï¼‰
                if (e.clientX < horizontalCenter) {
                    // æ’åˆ°å‰é¢
                    this.before(dragSrcEl);
                } else {
                    // æ’åˆ°åé¢
                    this.after(dragSrcEl);
                }
                // ä¿å­˜æ–°é¡ºåº
                saveOrder();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            // åŒé‡ä¿é™©ï¼šæ¸…ç†æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„æç¤ºæ ·å¼
            document.querySelectorAll('.card').forEach(c => {
                c.classList.remove('drop-hint-before', 'drop-hint-after');
            });
            dragSrcEl = null;
        }

        // ä¿å­˜é¡ºåºåˆ°æœåŠ¡å™¨
        async function saveOrder() {
            const container = document.getElementById('gallery');
            // æŒ‰å½“å‰ DOM é¡ºåºè·å–æ‰€æœ‰ ID
            const cards = container.querySelectorAll('.card');
            const ids = Array.from(cards).map(c => c.getAttribute('data-id'));
            
            if(ids.length < 2) return; // åªæœ‰ä¸€ä¸ªä¸ç”¨ä¿å­˜

            try {
                // å‘é€åå°ä¿å­˜ï¼Œä¸éœ€è¦ç­‰å¾…ç»“æœæˆ–åˆ·æ–°é¡µé¢ï¼Œä½“éªŒæ›´æµç•…
                fetch('api/api.php?action=reorder_graphs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: ids })
                });
            } catch(e) {
                console.error("æ’åºä¿å­˜å¤±è´¥", e);
            }
        }

        // === åŸºç¡€åŠŸèƒ½ ===
        async function createNew() {
            const name = prompt("è¯·è¾“å…¥æ–°é¡¹ç›®åç§°", "æ–°é¡¹ç›®");
            if(!name || !name.trim()) return;
            try {
                const res = await fetch('api/api.php?action=create_graph', { method: 'POST', body: JSON.stringify({ name: name.trim() }) });
                const json = await res.json();
                if(json.status === 'success') location.href = `editor.html?id=${json.id}`; else alert(json.message);
            } catch(e) { alert('åˆ›å»ºå¤±è´¥'); }
        }

        async function renameGraph(id, oldName) {
            const newName = prompt("è¯·è¾“å…¥æ–°çš„é¡¹ç›®åç§°ï¼š", oldName);
            if (newName === null || newName.trim() === "" || newName === oldName) return;
            await fetch('api/api.php?action=rename_graph', { method: 'POST', body: JSON.stringify({ id: id, name: newName.trim() }) });
            loadList();
        }

        async function deleteGraph(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼")) return;
            await fetch('api/api.php?action=delete_graph', { method: 'POST', body: JSON.stringify({ id: id }) });
            loadList(); 
        }

        // åˆå§‹åŒ–
        loadList(); 
    </script>
</body>
</html>