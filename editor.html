<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>关系图</title>
    <script src="https://gw.alipayobjects.com/os/lib/antv/g6/4.8.24/dist/g6.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="fabBtn" class="fab-toggle" onclick="toggleMobileView()">👁️</div>
    <div class="container">
        <div class="sidebar view-active" id="viewEditor">
            <div class="sidebar-header">
                <button class="btn btn-primary" style="width:100px; flex:0" onclick="location.href='index.html'">返回图库</button>
                <h3 id="page-title" style="margin:0; font-size:16px;">正在加载...<span style="font-size:11px;color:#1890ff;">云</span></h3>
                <div id="status-indicator"><div class="status-dot"></div><span id="status-text">就绪</span></div>
            </div>

            <div class="sidebar-fixed-config">
                <details class="config-wrapper">
                    <summary>⚙️ 全局配置</summary>
                    
                    <div class="tab-header">
                        <button class="tab-btn active" onclick="switchTab(this, 'tab-layout')">🛠️ 布局与显示</button>
                        <button class="tab-btn" onclick="switchTab(this, 'tab-faction')">🎨 阵营颜色</button>
                    </div>
                    
                    <div id="tab-layout" class="tab-content active">
                        <div class="config-row">
                            <span>删除确认</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="cfg-confirm-del" checked onchange="saveDataToServer()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="config-row">
                            <span>布局算法</span>
                            <select id="cfg-layout-type" class="config-select" onchange="updateGraph()">
                                <option value="force">🌌 力导向 (推荐)</option>
                                <option value="circular">⭕ 环形布局</option>
                                <option value="radial">☢️ 辐射布局</option>
                                <option value="grid">▦ 网格布局</option>
                                <option value="dagre">🌲 层次/族谱</option>
                            </select>
                        </div>

                        <div class="config-row">
                            <span>间距/半径</span>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="range" id="cfg-link-dist" class="range-slider" min="50" max="500" value="150" oninput="updateDistLabel();" onchange="updateGraph()">
                                <span id="lbl-dist-val" style="font-size:12px; color:#999; width:30px;">150</span>
                            </div>
                        </div>
                        <div class="config-row">
                            <span>文字样式</span>
                            <select id="cfg-label-mode" class="config-select" onchange="updateGraph()">
                                <option value="inside">⚪ 内嵌 (白字)</option>
                                <option value="bottom">⬇️ 下方 (黑字)</option>
                            </select>
                        </div>
                        <div class="config-row"><span>连线形状</span>
                            <select id="cfg-edge-type" class="config-select" onchange="updateGraph()">
                                <option value="quadratic" selected>贝塞尔</option>
                                <option value="line">直线</option>
                                <option value="polyline">折线</option>
                            </select>
                        </div>
                        <div class="config-row"><span>显示箭头</span><label class="toggle-switch"><input type="checkbox" id="cfg-show-arrow" checked onchange="updateGraph()"><span class="slider"></span></label></div>
                        <div class="config-row"><span>小地图</span><label class="toggle-switch"><input type="checkbox" id="cfg-minimap" onchange="toggleMinimap(); updateGraph()"><span class="slider"></span></label></div>
                        <div class="config-row">
                        <span>自动节点大小</span>
                        <label class="toggle-switch">
                        <input type="checkbox" id="cfg-auto-size" checked onchange="updateGraph()">
                        <span class="slider"></span>
                        </label>
                        </div>
                        <div class="config-row">
                        <span>显示图例</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cfg-show-legend" checked onchange="updateGraph()">
                            <span class="slider"></span>
                        </label>
                    </div>
                        <div class="config-row"><span>智能显隐 (LOD)</span><label class="toggle-switch"><input type="checkbox" id="cfg-lod" checked onchange="handleLOD(); updateGraph()"><span class="slider"></span></label></div>
                    </div>

                    <div id="tab-faction" class="tab-content">
                        <div id="factionConfigList"></div>
                        <button class="btn-add-mini" style="margin-top:10px" onclick="addFactionConfigRow()">+ 添加新阵营</button>
                    </div>
                </details>
            </div>

            <div class="sidebar-scroll-area">
                <details class="data-panel">
                    <summary>Nodes (人物节点)</summary>
                    <div class="list-header">
                        <div style="flex:1">人物名称</div>
                        <div style="flex:1">所属阵营</div>
                        <div style="width:24px"></div>
                    </div>
                    <div id="nodeListContainer" class="list-container"></div>
                    <div style="padding:0 15px 10px;"><button class="btn-add-mini" onclick="addNodeRow()">+ 添加人物</button></div>
                </details>

                <details class="data-panel" open>
                    <summary>Edges (关系连线)</summary>
                    <div class="list-header">
                        <div style="flex:1">人物 (Source)</div>
                        <div style="flex:1">关系 (Label)</div>
                        <div style="flex:1">目标 (Target)</div>
                        <div style="width:24px"></div>
                    </div>
                    <div id="edgeListContainer" class="list-container"></div>
                    <div style="padding:0 15px 10px;"><button class="btn-add-mini" onclick="addEdgeRow()">+ 添加关系</button></div>
                </details>
            </div>

            <div class="sidebar-footer">
                <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="handleFileImport(this)">
                <button class="btn btn-primary" onclick="updateAndGoGraph()">💾 保存并刷新</button>
                <button class="btn btn-success" onclick="downloadJSON()">💾 导出JSON</button>
            </div>
        </div>

        <div class="main-view" id="viewGraph">
            <div class="legend-box" id="legend"></div>
            <div id="mountNode" style="width:100%; height:100%;"></div>
        </div>
    </div>
    
    <datalist id="node-name-list"></datalist>

    <script src="js/graph_render.js"></script>
    <script src="js/data_ui.js"></script>
</body>
</html>